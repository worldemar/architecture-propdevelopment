# Диаграммы C4

## Подготовка

### Анализ текущей диаграммы

Предложенная в задании [диаграмма](../doc/task/PropDevelopment_С4_model.drawio) содержит ряд недостатков:

- **Содержит пересекающиеся связи** - это снижает читаемость
- **Содержит неподписанные связи** - это снижает информативность
- **Содержит дублирующиеся элементы** - создаёт путаницу
- **Содержит только один слой C4** - зашумляет диаграмму множеством элементов из-за попыток отразить на ней сразу всё
- **Содержит Component оформленные как Container** - нарушает границы слоёв C4
- **Содержит элементы не из стандарта C4** - затрудняет понимание, требует дополнительного поиска информации

Чтобы начать любую работу над диаграммами нужно привести изначальную диаграмму в формат C4.

### План корректирующих действий

Для устранения этих недостатков предпримем следующие действия:

- **Содержит пересекающиеся связи**
  - Конвертировать диаграмму в PlantUML, где связи будут показаны явно в коде.
  - Разнести элементы дальше друг от друга, воспользоваться выравниванием PlantUML
- **Содержит неподписанные связи**
  - Чтобы не спекулировать о целях задания - подписи оставить как есть.
  - При анализе подразумевать, что их забыли нанести на диаграмму, и связь между элементами присутствует.
- **Содержит дублирующиеся элементы**
  - Из диалога с наставником стало ясно, что это - опечатка.
  - Индексировать дублирующийся элемент как второй, считать его отдельным элементом.
- **Содержит только один слой C4**
  - Создать слои диаграмм: Context, Container, Component
- **Содержит Component оформленные как Container**
  - Оформить элементы корректно, в частности:
    - Микросервис и его БД - не как разные контейнеры, а как один контейнер с двумя компонентами внутри.
    - В виду отсутствия деталей оформить микросервис как один компонент, в реальном кейсе их было бы несколько.
- **Содержит элементы не из стандарта C4**
  - В частности - Firewall, который оформлен как картинка поверх связи. Его нужно сделать отдельным контейнером.
  - Поскольку их два - допустим два разных контейнера, так как в реальном кейсе это могут быть два независимых брандмауэра.

### Шаг 1: конвертация диаграммы в PlantUML и коррекция типов элементов

![c4/as-is.puml](c4/as-is.png)

### Шаг 2: схлопывание компонентов

#### Диаграмма контекста

![c4/context/as-is.puml](c4/context/as-is.png)

#### Диаграмма контейнеров

![c4/container/as-is.puml](c4/container/as-is.png)

#### Диаграммы компонентов

![c4/component/as-is-prop.client.mart_estate.puml](c4/component/as-is-prop.client.mart_estate.png)
![c4/component/as-is-prop.client.mart.puml](c4/component/as-is-prop.client.mart.png)
![c4/component/as-is-prop.client.tour.puml](c4/component/as-is-prop.client.tour.png)
![c4/component/as-is-prop.client.crm.puml](c4/component/as-is-prop.client.crm.png)
![c4/component/as-is-prop.zku.tenant_core.puml](c4/component/as-is-prop.zku.tenant_core.png)
![c4/component/as-is-prop.zku.crm.puml](c4/component/as-is-prop.zku.crm.png)
![c4/component/as-is-prop.auth.puml](c4/component/as-is-prop.auth.png)
![c4/component/as-is-prop.accountant_service.puml](c4/component/as-is-prop.accountant_service.png)
![c4/component/as-is-prop.storage.puml](c4/component/as-is-prop.storage.png)

## Добавление новых бизнес-функций

### Диаграммы «to-be»

#### Диаграмма контекста

![c4/context/to-be.puml](c4/context/to-be.png)

#### Диаграмма контейнеров

![c4/container/to-be.puml](c4/container/to-be.png)

#### Диаграмма компонента smart-access-service

![c4/component/to-be-prop.zku.smart_access.puml](c4/component/to-be-prop.zku.smart_access.png)

### Требования к внешним интеграциям («Умный дом»)

- Безопасность
  - Шифрование трафика: HTTPS (TLS 1.2+) между всеми внешними взаимодействиями.
  - Взаимная аутентификация сервис–сервис: mTLS между `prop.zku.smart_access` и платформой партнёра.
  - Подпись вебхуков: HMAC (sha256) или JWS; верификация подписи, времени, повтора (идемпотентность).
  - Сегментация/фаерволы: allowlist IP партнёра для приёма вебхуков; отдельная DMZ-зона для входящих запросов.
  - Секреты: хранение в защищённом хранилище; регулярная ротация ключей/сертификатов.
  - Лимиты/защита: rate limiting, retries с экспоненциальной паузой, circuit breaker; дедупликация событий.
  - Логи и аудит: трассировка, аудит действий доступа, раздельные уровни логирования без ПДн.
  - Минимизация ПДн: у партнёра хранятся биометрические шаблоны; у нас — идентификаторы, связи и согласия.
  - Соответствие законодательству РФ: хранение и обработка ПДн по 152-ФЗ; учёт согласий.
  - Межарендная изоляция: tenant-id/house-id в каждом запросе/событии; фильтрация и проверка границ домена данных.
  - Договорные документы с партнёром: DPA/DPIA/ДС; разграничение ответственности, границы обработки (включая биометрию).
  - DSAR (запросы субъектов): каскадное удаление/исправление у партнёра и в наших системах по ссылочным идентификаторам.
  - Trust management: pinning ключей/CA, регламент ротации цепочек доверия для mTLS и подписи вебхуков.
  - Пер-арендные квоты и алерты: отдельные лимиты/пороговые значения и мониторинг аномалий на tenant-уровне.
  - Песочницы/стенды партнёра: отдельные сертификаты/секреты, тестовые данные, изоляция от продакшена.

- Аутентификация и авторизация
  - Пользовательская (моб. приложение): OIDC через `prop.auth` (Keycloak) как и сейчас.
  - Межсервисная:
    - `prop.zku.tenant_core` -> `prop.zku.smart_access`: mTLS + сервисные учётные данные (JWT) со скоупами.
    - `prop.zku.smart_access` -> платформа партнёра: OAuth2 Client Credentials (или JWT Bearer), ограниченные скоупы.
    - Вебхуки: аутентификация по mTLS и/или по подписи (HMAC/JWS), проверка заголовков и списка IP.
  - Авторизация:
    - Внутри smart-access — policy engine (роли, зоны, окна времени, список авто, связи).
    - Readonly-доступ к CRM (`prop.zku.crm`) только для обогащения контекстом.

- Организация взаимодействия
  - Команды (исходящие к партнёру): `prop.zku.tenant_core` -> `prop.zku.smart_access.api` -> `prop.zku.smart_access.partner_client` -> Smart Home Platform. Ответы валидируются, ошибки - с ретраями/идемпотентностью.
  - События (входящие вебхуки): Smart Home Platform -> `prop.zku.smart_access.webhook_handler` (подпись/идемпотентность) -> запись в `smart-access-db` -> CDC в DWH.
  - Обогащение (только чтение!): `prop.zku.smart_access.api` запрашивает `prop.zku.crm` для проверки владения/ролей/статусов договора; данные не кэшируются дольше, чем необходимо.
  - Аналитика: `smart-access-db` -> `prop.storage` (CDC) для BI и отчётности.
  - Версионирование контрактов: v1/v2 endpoint-ы; обратная совместимость, отдельные песочницы и тестовые среды.
  - Наблюдаемость: метрики доступности/латентности интеграций, алерты по SLO/SLA, трассировка end-to-end.
